%%{init: {'theme': 'dark', 'themeVariables': { 'fontSize': '20px', 'fontFamily': 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif' }}}%%
flowchart TB
    subgraph Client [User Space]
        Browser["Browser / Static Console<br>(public/index.html)"]
    end

    subgraph Azure ["Azure Cloud (West US 3)"]
        
        subgraph AKS ["AKS Cluster"]
            ALB["Azure Load Balancer"]

            subgraph App ["Drogon Application (C++20)"]
                direction TB
                Router["Main / Router"]
                
                subgraph Controllers ["Controllers"]
                    direction LR
                    AC["AuthController"]
                    US["UrlShortenerService"]
                end
                
                subgraph Services ["Services"]
                    direction LR
                    AS["AuthService"]
                    DS["DataStore (ORM)"]
                end
            end

            Redis[("Self-hosted Redis<br>(Helm Chart)")]
            Postgres[("Self-hosted PostgreSQL<br>(Helm Chart)")]
        end
    end

    Browser -->|HTTPS| ALB
    ALB -->|ClusterIP| Router
    
    Router --> AC
    Router --> US
    
    AC --> AS
    US --> AS
    
    AS --> DS
    US --> DS
    
    DS -->|libpq over TLS| Postgres
    US -->|TCP Cache-Aside| Redis
    Postgres -.->|Cached Data| Redis

    %% Styling
    classDef default color:#fff,stroke-width:2px;
    
    style Browser fill:#4a148c,stroke:#ea80fc
    style ALB fill:#424242,stroke:#bdbdbd,stroke-dasharray: 5 5
    
    style AKS fill:#004d40,stroke:#80cbc4,color:#fff
    style App fill:#01579b,stroke:#81d4fa,color:#fff
    style Router fill:#0277bd,stroke:#81d4fa
    
    style AC fill:#f57f17,stroke:#fbc02d,color:#000
    style US fill:#f57f17,stroke:#fbc02d,color:#000
    style AS fill:#558b2f,stroke:#aed581
    style DS fill:#558b2f,stroke:#aed581

    style Redis fill:#bf360c,stroke:#ffab91
    style Postgres fill:#bf360c,stroke:#ffab91
