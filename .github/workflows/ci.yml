name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (apt)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake git pkg-config \
            libjsoncpp-dev uuid-dev libssl-dev zlib1g-dev \
            libc-ares-dev libbrotli-dev libpq-dev curl

      - name: Build (CMake)
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)

      - name: Smoke test (run & curl)
        run: |
          ./build/url_shortener &
          PID=$!
          for i in $(seq 1 30); do
            if curl -fsS http://localhost:9090/api/v1/health >/dev/null 2>&1; then
              echo "Health OK"; break; fi; sleep 1; done
          curl -fsS -X POST -H 'Content-Type: application/json' \
            -d '{"url":"https://example.com","ttl":30}' \
            http://localhost:9090/api/v1/shorten | tee /tmp/short.json
          kill $PID || true
          test -s /tmp/short.json

      - name: Docker build
        run: docker build -t url-shortener:ci .

  formatting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: clang-format check (if config exists)
        run: |
          if ls src/*.cpp src/*.h >/dev/null 2>&1; then \
            sudo apt-get update && sudo apt-get install -y clang-format; \
            clang-format --version; \
            CHANGED=$(git ls-files src/*.cpp src/*.h | xargs clang-format -n --Werror 2>&1 || true); \
            if [ -n "$CHANGED" ]; then echo "Formatting issues found"; echo "$CHANGED"; exit 1; fi; \
            echo "Formatting OK"; \
          else \
            echo "No C++ sources found"; \
          fi
